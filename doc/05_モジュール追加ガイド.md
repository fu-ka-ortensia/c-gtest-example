# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆä¾‹ï¼šmoduleDï¼‰ã‚’è¿½åŠ ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰

### 1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•è¿½åŠ ï¼ˆæœ€ã‚‚ç°¡å˜ï¼‰

```bash
cd /home/fu-ka/c_test_prj
./tools/add_module.sh moduleD
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ä»¥ä¸‹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™:

```
target/jchg/moduleD/
â”œâ”€â”€ moduleD.h
â””â”€â”€ moduleD.c

tests/moduleD/
â”œâ”€â”€ test_moduleD.cpp
â””â”€â”€ CMakeLists.txt

double/moduleD/
â””â”€â”€ moduleD_stub.c
```

### 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å®Ÿè£…

**target/jchg/moduleD/moduleD.c**:
```c
#include "moduleD.h"

s4 moduleD_function1(s4 value) {
    // TODO: å®Ÿè£…ã‚’è¿½åŠ 
    return value;
}
```

**target/jchg/moduleD/moduleD.h**:
```c
#ifndef MODULED_H
#define MODULED_H

#include "common.h"

s4 moduleD_function1(s4 value);

#endif
```

**tests/moduleD/test_moduleD.cpp**:
```cpp
TEST_F(ModuleDTest, Function1_BasicTest) {
    s4 result = moduleD_function1(100);
    EXPECT_EQ(100, result);
}
```

### 3. ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆ

```bash
cd build
cmake ..
make
ctest --output-on-failure
```

---

## ğŸ“‹ æ‰‹å‹•è¿½åŠ æ‰‹é †ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå¤±æ•—æ™‚ã®ä»£æ›¿ï¼‰

ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½¿ç”¨ã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§æ‰‹å‹•è¿½åŠ ã§ãã¾ã™ã€‚

### Step 1: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ

```bash
mkdir -p target/jchg/moduleD
mkdir -p tests/moduleD
mkdir -p double/moduleD
```

### Step 2: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦åå‰ç½®æ›

#### 2-1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```bash
# ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç½®æ›
sed 's/template/moduleD/g; s/TEMPLATE/MODULED/g' \
    target/jchg/_template/module_template.h > target/jchg/moduleD/moduleD.h

# ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç½®æ›
sed 's/template/moduleD/g' \
    target/jchg/_template/module_template.c > target/jchg/moduleD/moduleD.c
```

#### 2-2. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```bash
# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç½®æ›
sed 's/template/moduleD/g; s/Template/ModuleD/g' \
    tests/_template/test_module_template.cpp > tests/moduleD/test_moduleD.cpp

# CMakeLists.txt ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç½®æ›
sed 's/template/moduleD/g; s/Template/ModuleD/g' \
    tests/_template/CMakeLists.txt.template > tests/moduleD/CMakeLists.txt
```

#### 2-3. ã‚¹ã‚¿ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```bash
sed 's/template/moduleD/g' \
    double/_template/module_stub_template.c > double/moduleD/moduleD_stub.c
```

### Step 3: tests/CMakeLists.txt ã«è¿½åŠ 

**tests/CMakeLists.txt**:

```cmake
add_subdirectory(moduleA)
add_subdirectory(moduleB)
add_subdirectory(moduleC)
add_subdirectory(moduleD)  # â† è¿½åŠ 
```

### Step 4: ãƒ“ãƒ«ãƒ‰è¨­å®šã‚’ç¢ºèª

CMakeLists.txt (ãƒ«ãƒ¼ãƒˆ) ãŒè‡ªå‹•çš„ã« tests ãƒ•ã‚©ãƒ«ãƒ€ä»¥ä¸‹ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‹ç¢ºèª:

```cmake
# CMakeLists.txtï¼ˆãƒ«ãƒ¼ãƒˆï¼‰
add_subdirectory(tests)
```

---

## ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†…å®¹

### target/jchg/_template/module_template.h

**å½¹å‰²**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```c
#ifndef MODULE_TEMPLATE_H
#define MODULE_TEMPLATE_H

#include "common.h"

s4 module_template_function1(s4 value);
u4 module_template_function2(u1* data, u4 length);

#endif
```

**ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ**:
- é–¢æ•°åã‚’å¤‰æ›´
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹ã‚’å¤‰æ›´
- æˆ»ã‚Šå€¤å‹ã‚’å¤‰æ›´

### target/jchg/_template/module_template.c

**å½¹å‰²**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```c
#include "module_template.h"

s4 module_template_function1(s4 value) {
    // TODO: å®Ÿè£…ã‚’è¿½åŠ 
    return value;
}

u4 module_template_function2(u1* data, u4 length) {
    if (data == NULL || length == 0) {
        return 0;
    }
    return length;
}
```

**ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ**:
- TODO: å®Ÿè£…ã‚’è¿½åŠ  ã®éƒ¨åˆ†ã«å®Ÿè£…ã‚’è¿½åŠ 

### tests/_template/test_module_template.cpp

**å½¹å‰²**: GTest ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```cpp
#include <gtest/gtest.h>

extern "C" {
    #include "module_template.h"
}

class ModuleTemplateTest : public ::testing::Test {
    // ãƒ†ã‚¹ãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
};

TEST_F(ModuleTemplateTest, Function1_BasicTest) {
    // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
}
```

**ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ**:
- SetUp()/TearDown() ã«åˆæœŸåŒ–/ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’è¿½åŠ 
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ /å‰Šé™¤

### tests/_template/CMakeLists.txt.template

**å½¹å‰²**: CMake ãƒ†ã‚¹ãƒˆãƒ“ãƒ«ãƒ‰è¨­å®šã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```cmake
cmake_minimum_required(VERSION 3.10)

set(MODULE_NAME template)

add_executable(test_module_${MODULE_NAME} test_module_${MODULE_NAME}.cpp)

target_include_directories(test_module_${MODULE_NAME} PRIVATE
    ${CMAKE_SOURCE_DIR}/target/jchg/${MODULE_NAME}
    ${CMAKE_SOURCE_DIR}/target/inc
    ${CMAKE_SOURCE_DIR}/fff
)

target_link_libraries(test_module_${MODULE_NAME}
    gtest
    gtest_main
    pthread
)

target_compile_options(test_module_${MODULE_NAME} PRIVATE
    -O0 -g --coverage -fprofile-arcs -ftest-coverage
)
target_link_options(test_module_${MODULE_NAME} PRIVATE
    --coverage -fprofile-arcs -ftest-coverage
)

add_test(NAME Module${MODULE_NAME}Test COMMAND test_module_${MODULE_NAME})
```

**ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ**:
- è¿½åŠ ã® include ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå¿…è¦ãªå ´åˆã¯ `target_include_directories` ã«è¿½åŠ 
- è¿½åŠ ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ãªå ´åˆã¯ `target_link_libraries` ã«è¿½åŠ 

### double/_template/module_stub_template.c

**å½¹å‰²**: FFF ã‚¹ã‚¿ãƒ–ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```c
/**
 * @file module_stub.c
 * @brief FFF Stubs for module_template external functions
 */

#include "module_template.h"

#define DEFINE_FFF_GLOBALS
#include "fff.h"

// ã‚¹ã‚¿ãƒ–å®£è¨€ä¾‹:
// FAKE_VALUE_FUNC2(u4, external_function, u1*, u4);
```

**ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ**:
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§ä½¿ç”¨ã™ã‚‹å¤–éƒ¨é–¢æ•°ã‚’ã‚¹ã‚¿ãƒ–åŒ–

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸ

A. ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œå¯èƒ½ã‹ç¢ºèª:
   ```bash
   ls -la tools/add_module.sh
   # å®Ÿè¡Œå¯èƒ½ã§ãªã„å ´åˆ:
   chmod +x tools/add_module.sh
   ```

2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åãŒæœ‰åŠ¹ã‹ç¢ºèª:
   ```bash
   # æœ‰åŠ¹: moduleD, MODULE_E, my_module_1
   # ç„¡åŠ¹: 4module (æ•°å­—ã§å§‹ã¾ã‚‹), my-module (ãƒã‚¤ãƒ•ãƒ³)
   ```

3. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¦ã„ãªã„ã‹ç¢ºèª:
   ```bash
   ls -la target/jchg/ | grep moduleD
   ```

### Q. æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã„

A. ä¸Šè¨˜ã®ã€Œæ‰‹å‹•è¿½åŠ æ‰‹é †ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Q. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ãŸã„

A. ä»¥ä¸‹ã§å‰Šé™¤ã§ãã¾ã™:

```bash
rm -rf target/jchg/moduleD
rm -rf tests/moduleD
rm -rf double/moduleD

# tests/CMakeLists.txt ã‹ã‚‰è©²å½“è¡Œã‚’å‰Šé™¤
sed -i '/add_subdirectory(moduleD)/d' tests/CMakeLists.txt
```

### Q. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„

A. `_template` ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ãã ã•ã„:

```bash
# ä¾‹ï¼štarget/jchg/_template/module_template.c ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†
vim target/jchg/_template/module_template.c
```

æ–°ã—ãè¿½åŠ ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ä»Šå¾Œã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ã«åæ˜ ã•ã‚Œã¾ã™ã€‚

---

## ğŸ“ ã‚ˆãã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³ 1: å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–¢æ•°ï¼ˆä¾‹ï¼šu4g_mem_writeï¼‰ã‚’ã‚¹ã‚¿ãƒ–åŒ–ã™ã‚‹å ´åˆ:

**tests/moduleD/test_moduleD.cpp**:

```cpp
extern "C" {
    #include "moduleD.h"
    #define DEFINE_FFF_GLOBALS
    #include "fff.h"
    FAKE_VALUE_FUNC2(u4, u4g_mem_write, u1*, u4);
}

TEST_F(ModuleDTest, WriteDataTest) {
    RESET_FAKE(u4g_mem_write);
    u4g_mem_write_fake.return_val = 4;
    
    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    // ...
    
    EXPECT_EQ(1, u4g_mem_write_fake.call_count);
}
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³ 2: è¤‡æ•°ã®é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

è¤‡æ•°ã®é–¢æ•°ãŒã‚ã‚‹å ´åˆã€ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚½ãƒ¼ã‚¹ã«è¿½åŠ :

**target/jchg/moduleD/moduleD.h**:

```c
s4 moduleD_function1(s4 value);
s4 moduleD_function2(s4 a, s4 b);
u4 moduleD_function3(u1* data, u4 length);
```

**target/jchg/moduleD/moduleD.c**:

```c
s4 moduleD_function1(s4 value) { ... }
s4 moduleD_function2(s4 a, s4 b) { ... }
u4 moduleD_function3(u1* data, u4 length) { ... }
```

**tests/moduleD/test_moduleD.cpp**:

```cpp
TEST_F(ModuleDTest, Function1_Test) { ... }
TEST_F(ModuleDTest, Function2_Test) { ... }
TEST_F(ModuleDTest, Function3_Test) { ... }
```

---

## ğŸ“– å‚ç…§

- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦](00_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦.md)
- [ç’°å¢ƒæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰](01_ç’°å¢ƒæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰.md)
- [ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ãƒ†ã‚¹ãƒˆèª¬æ˜](02_ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ãƒ†ã‚¹ãƒˆèª¬æ˜.md)
- [FFFã‚¹ã‚¿ãƒ–åŒ–ã‚¬ã‚¤ãƒ‰](03_FFFã‚¹ã‚¿ãƒ–åŒ–ã‚¬ã‚¤ãƒ‰.md)
- [ãƒ“ãƒ«ãƒ‰ã¨å®Ÿè¡Œã‚¬ã‚¤ãƒ‰](04_ãƒ“ãƒ«ãƒ‰ã¨å®Ÿè¡Œã‚¬ã‚¤ãƒ‰.md)
