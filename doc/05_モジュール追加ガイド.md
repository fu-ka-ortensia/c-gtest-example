# モジュール追加ガイド

このドキュメントでは、プロジェクトに新しいモジュールを追加する手順を説明します。

## 🚀 クイックスタート（推奨）

### 1. スクリプトを使用した自動追加（最も簡単）

```bash
cd /home/fu-ka/c_test_prj
./tools/add_module.sh <MODULE_NAME>
```

このコマンドで、以下が自動生成されます:

- `target/jchg/<MODULE_NAME>/` : モジュール実装ファイル
- `tests/<MODULE_NAME>/` : テストファイル
- `double/<MODULE_NAME>/` : スタブファイル

### 2. ファイルを編集して実装

テンプレートから生成されたファイルを編集して、モジュール実装とテストコードを記述します。

### 3. ビルドとテスト

```bash
cd build
cmake ..
make
ctest --output-on-failure
```

---

## 📋 手動追加手順（スクリプト失敗時の代替）

スクリプトが使用できない場合は、以下の手順で手動追加できます。

### Step 1: ディレクトリ構造の作成

```bash
mkdir -p target/jchg/<MODULE_NAME>
mkdir -p tests/<MODULE_NAME>
mkdir -p double/<MODULE_NAME>
```

### Step 2: テンプレートをコピーして名前置換

テンプレートファイルを sed コマンドで置換してコピーします。

#### 2-1. ターゲットファイルを作成

```bash
sed 's/template/<MODULE_NAME>/g; s/TEMPLATE/<MODULE_NAME_UPPER>/g' \
    tools/template/target/module_template.h > target/jchg/<MODULE_NAME>/<MODULE_NAME>.h

sed -e "s/module_template\.h/<MODULE_NAME>\.h/g" \
    -e "s/template/<MODULE_NAME>/g" \
    tools/template/target/module_template.c > target/jchg/<MODULE_NAME>/<MODULE_NAME>.c
```

#### 2-2. テストファイルを作成

```bash
sed -e "s/module_template\.h/<MODULE_NAME>\.h/g" \
    -e "s/template/<MODULE_NAME>/g" \
    -e "s/ModuleTemplate/<CLASS_NAME>/g" \
    tools/template/tests/test_module_template.cpp > tests/<MODULE_NAME>/test_<MODULE_NAME>.cpp

sed "s/template/<MODULE_NAME>/g" \
    tools/template/tests/CMakeLists.txt.template > tests/<MODULE_NAME>/CMakeLists.txt
```

#### 2-3. スタブファイルを作成

```bash
sed "s/template/<MODULE_NAME>/g" \
    tools/template/double/module_stub_template.c > double/<MODULE_NAME>/<MODULE_NAME>_stub.c
```

### Step 3: tests/CMakeLists.txt に追加

```cmake
add_subdirectory(<MODULE_NAME>)
```

### Step 4: ビルド設定を確認

CMakeLists.txt (ルート) が自動的に tests フォルダ以下をビルドするか確認:

```cmake
add_subdirectory(tests)
```

---

## 📁 テンプレートの内容と場所

テンプレートファイルは `tools/template/` フォルダ以下に管理されています。

### tools/template/target/

**役割**: ターゲットモジュール実装のテンプレート

- `module_template.h` : ヘッダーテンプレート
- `module_template.c` : 実装テンプレート

**カスタマイズポイント**:
- テンプレートを編集して新しいモジュールに必要な関数シグネチャを定義

### tools/template/tests/

**役割**: GTest テストファイルのテンプレート

- `test_module_template.cpp` : テストテンプレート
- `CMakeLists.txt.template` : CMake ビルド設定テンプレート

**カスタマイズポイント**:
- テストケースを追加/削除

### tools/template/double/

**役割**: FFF スタブファイルのテンプレート

- `module_stub_template.c` : スタブテンプレート

**カスタマイズポイント**:
- 外部依存関数をスタブ化する場合に使用

---

## 🔧 トラブルシューティング

### Q. スクリプトでエラーが出た

A. 以下を確認してください:

1. スクリプトが実行可能か確認:
   ```bash
   ls -la tools/add_module.sh
   # 実行可能でない場合:
   chmod +x tools/add_module.sh
   ```

2. モジュール名が有効か確認:
   ```bash
   # 有効: moduleD, MODULE_E, my_module_1
   # 無効: 4module (数字で始まる), my-module (ハイフン)
   ```

3. モジュールが既に存在していないか確認

### Q. モジュールを削除したい

A. 作成したディレクトリとファイルを削除し、`tests/CMakeLists.txt` から該当行を削除してください

### Q. テンプレートをカスタマイズしたい

A. `tools/template/` フォルダ内のファイルを編集してください。新しく追加するモジュールはこのテンプレートから生成されます。

## 📖 参照

- [プロジェクト概要](00_プロジェクト概要.md)
- [環境構築ガイド](01_環境構築ガイド.md)
- [モジュール別テスト説明](02_モジュール別テスト説明.md)
- [FFFスタブ化ガイド](03_FFFスタブ化ガイド.md)
- [ビルドと実行ガイド](04_ビルドと実行ガイド.md)
