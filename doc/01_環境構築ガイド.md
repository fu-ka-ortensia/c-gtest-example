# 環境構築ガイド

## 必要な環境

- **OS**: Linux（Ubuntu 推奨）
- **コンパイラ**: GCC（C と C++）
- **ビルドツール**: CMake 3.10 以上
- **その他**: make、gcov（オプション：カバレッジ測定用）

## 前提条件のインストール

### Ubuntu/Debian

```bash
# システムパッケージの更新
sudo apt update
sudo apt upgrade

# ビルド必須ツール
sudo apt install -y build-essential cmake git

# カバレッジ測定用（オプション）
sudo apt install -y gcovr lcov
```

### パッケージのバージョン確認

```bash
gcc --version      # GCC のバージョン確認
g++ --version      # G++ のバージョン確認
cmake --version    # CMake のバージョン確認
make --version     # make のバージョン確認
```

## プロジェクトの初期セットアップ

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd c_test_prj
```

### 2. ビルドディレクトリの作成とセットアップ

```bash
# ビルドディレクトリの作成
mkdir -p build
cd build

# CMake 設定（Debug ビルド推奨）
cmake .. -DCMAKE_BUILD_TYPE=Debug

# または Release ビルド
# cmake .. -DCMAKE_BUILD_TYPE=Release
```

### 3. プロジェクトのビルド

```bash
# ビルド実行
make

# または並列ビルド（高速）
make -j$(nproc)
```

### 4. ビルド成功の確認

ビルド完了後、以下のディレクトリが生成されます：

```
build/
├── lib/                          # ビルドされたライブラリ
├── GoogleTest/                   # GTest フレームワーク
├── tests/
│   ├── moduleA/test_moduleA      # moduleA テスト実行ファイル
│   ├── moduleB/test_moduleB      # moduleB テスト実行ファイル
│   └── moduleC/test_moduleC      # moduleC テスト実行ファイル
└── CMakeFiles/                   # CMake ビルド情報
```

## ファイルディレクトリの役割

### target/inc/ - 共通ヘッダー

| ファイル名 | 説明 |
|-----------|------|
| `common.h` | 基本型定義（u1, s4, u4 など） |
| `u4g_mem.h` | 外部モジュール関数の宣言 |

### target/jchg/ - モジュール実装

各モジュール（moduleA、moduleB、moduleC）の実装ファイル：
- `.h`: ヘッダーファイル（I/F 関数の宣言）
- `.c`: 実装ファイル

### tests/ - テストファイル

各モジュールのテストファイル：
- `test_moduleA.cpp`
- `test_moduleB.cpp`
- `test_moduleC.cpp`

**特徴**:
- GTest フレームワークを使用した C++ テスト
- 各テストファイルで C ソースを extern "C" ブロック内で include
- FFF でスタブ化した外部関数を使用

### double/ - スタブファイル

外部依存関係のモック/スタブ定義（現在は未使用、将来の拡張用）

### fff/ - FFF フレームワーク

Fake Functions Framework のヘッダーファイル：
- `fff.h`: マクロと機能提供

## CMake ビルド設定

### ルート CMakeLists.txt

- GTest の Add Subdirectory
- テストの自動検出（CTest）
- グローバルなコンパイルオプション設定

### 各モジュールの CMakeLists.txt

例：`tests/moduleC/CMakeLists.txt`

```cmake
cmake_minimum_required(VERSION 3.10)

add_executable(test_moduleC 
    test_moduleC.cpp
)

target_include_directories(test_moduleC PRIVATE 
    ${CMAKE_SOURCE_DIR}/target/jchg/moduleC
    ${CMAKE_SOURCE_DIR}/target/inc
    ${CMAKE_SOURCE_DIR}/fff
)

# カバレッジオプション
target_compile_options(test_moduleC PRIVATE --coverage -fprofile-arcs -ftest-coverage)
target_link_options(test_moduleC PRIVATE --coverage -lgcov)

target_link_libraries(test_moduleC 
    gtest 
    gtest_main
    pthread
)

add_test(NAME ModuleCTests COMMAND test_moduleC)
```

## ビルドオプション

### Debug ビルド（開発用）

```bash
cmake .. -DCMAKE_BUILD_TYPE=Debug
```

- 最適化なし（-O0）
- デバッグシンボル付き（-g）
- カバレッジ情報収集（--coverage）

### Release ビルド（本番用）

```bash
cmake .. -DCMAKE_BUILD_TYPE=Release
```

- 最適化有効（-O2 または -O3）
- デバッグシンボルなし
- 高速実行

## クリーンビルド

```bash
# ビルドディレクトリをクリア
cd /home/fu-ka/c_test_prj
rm -rf build

# 新規ビルド
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Debug
make
```

## トラブルシューティング

### CMake が見つからない

```bash
sudo apt install cmake
```

### GCC/G++ が見つからない

```bash
sudo apt install build-essential
```

### 古い CMake バージョンのエラー

```bash
# CMake をアップグレード
sudo apt install --only-upgrade cmake
```

### ビルド中の定義エラー

```bash
# クリーンビルドを実行
make clean
make
```
