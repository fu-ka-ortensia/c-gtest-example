# モジュール別テスト説明

## moduleC テスト

### テスト対象ファイル

- **実装**: `target/jchg/moduleC/moduleC.c`
- **ヘッダー**: `target/jchg/moduleC/moduleC.h`
- **テスト**: `tests/moduleC/test_moduleC.cpp`

### moduleC の機能

moduleC は、moduleA と moduleB の結果を統合・検証・正規化するモジュールです。

#### 1. `moduleC_integrate(s4 valueA, s4 valueB)` → s4

**機能**: 加重平均を計算
- valueA: 60% の重み
- valueB: 40% の重み
- 戻り値: $(valueA \times 60 + valueB \times 40) / 100$

**テストケース**:

| テスト名 | 入力 | 期待値 | 説明 |
|---------|------|--------|------|
| IntegrateBasic | (100, 0) | 60 | 基本的な加重平均 |
| IntegrateBasic | (0, 100) | 40 | 基本的な加重平均 |
| IntegrateWeightedAverage | (100, 50) | 80 | 加重平均の検証 |
| IntegrateNegativeValues | (-50, 50) | -10 | 負の値の処理 |

#### 2. `moduleC_validate(s4 result)` → s4

**機能**: 結果が 0-100 の範囲内かバリデーション
- 戻り値: 1（成功）または 0（失敗）

**テストケース**:

| テスト名 | 入力 | 期待値 | 説明 |
|---------|------|--------|------|
| ValidateWithinRange | 50 | 1 | 範囲内 |
| ValidateOutOfRange | -1 | 0 | 範囲外（負） |
| ValidateOutOfRange | 101 | 0 | 範囲外（正） |

#### 3. `moduleC_normalize(s4 value, s4 min, s4 max)` → s4

**機能**: 値を指定範囲内に正規化
- value < min → min を返す
- value > max → max を返す
- それ以外 → value をそのまま返す

**テストケース**:

| テスト名 | 入力 | 期待値 | 説明 |
|---------|------|--------|------|
| NormalizeWithinRange | (50, 0, 100) | 50 | 範囲内 |
| NormalizeBelowMin | (5, 10, 100) | 10 | 最小値で正規化 |
| NormalizeAboveMax | (150, 0, 100) | 100 | 最大値で正規化 |

#### 4. `moduleC_write_data(u1* data, u4 length)` → u4

**機能**: データを外部モジュール（u4g_mem_wirte）に書き込み
- 戻り値: 実際に書き込まれたバイト数

**外部依存**: `u4g_mem_wirte(u1* data, u4 length)`

**テストケース**（FFF スタブ使用）:

| テスト名 | 説明 |
|---------|------|
| WriteDataSuccess | 正常系（4バイト書き込み成功） |
| WriteDataPartialSuccess | 部分的な書き込み（2バイトのみ成功） |
| WriteDataEmptyBuffer | 空バッファの処理 |
| WriteDataMultipleCalls | 複数呼び出しのテスト |

### テストの実行

```bash
# 個別実行
cd build/tests/moduleC
./test_moduleC

# または CTest で実行
cd build
ctest --output-on-failure -V

# moduleC のみ実行
ctest -R "ModuleC" --output-on-failure
```

### テスト実行結果例

```
[==========] Running 15 tests from 1 test suite.
[----------] Global test environment set-up.
[----------] 15 tests from ModuleCTest
[ RUN      ] ModuleCTest.IntegrateBasic
[       OK ] ModuleCTest.IntegrateBasic (0 ms)
...
[ RUN      ] ModuleCTest.WriteDataMultipleCalls
[       OK ] ModuleCTest.WriteDataMultipleCalls (0 ms)
[----------] 15 tests from ModuleCTest (0 ms total)

[==========] 15 tests from 1 test suite ran. (0 ms total)
[  PASSED  ] 15 tests.
```

## moduleA テスト

### テスト対象ファイル

- **実装**: `target/jchg/moduleA/moduleA.c`
- **ヘッダー**: `target/jchg/moduleA/moduleA.h`
- **テスト**: `tests/moduleA/test_moduleA.cpp`

### 実行方法

```bash
cd build/tests/moduleA
./test_moduleA
```

## moduleB テスト

### テスト対象ファイル

- **実装**: `target/jchg/moduleB/moduleB.c`
- **ヘッダー**: `target/jchg/moduleB/moduleB.h`
- **テスト**: `tests/moduleB/test_moduleB.cpp`

### 実行方法

```bash
cd build/tests/moduleB
./test_moduleB
```

## 統合テスト実行

すべてのテストを一括実行：

```bash
cd build
ctest --output-on-failure
```

### 実行結果の表示

```bash
# 詳細表示
ctest --output-on-failure -V

# テスト結果を XML で出力
ctest -T Test --output-xml test-results.xml

# カバレッジレポート生成
ctest --coverage
```

## テストの特徴

### GTest フレームワーク

- **TEST マクロ**: テストケースの定義
  ```cpp
  TEST(テストスイート名, テストケース名) {
      // テスト実装
  }
  ```

- **EXPECT_EQ**: 値の等価性チェック
  ```cpp
  EXPECT_EQ(期待値, 実際の値);
  ```

- **ASSERT_**: テスト失敗時に即座に中断
  ```cpp
  ASSERT_EQ(期待値, 実際の値);
  ```

### FFF スタブ化

#### 基本的な使い方

```cpp
// 1. FFF グローバル変数を定義
DEFINE_FFF_GLOBALS;

// 2. スタブ関数を宣言（引数が 2 個の場合）
FAKE_VALUE_FUNC2(u4, u4g_mem_wirte, u1*, u4);

// 3. テスト内で使用
TEST(ModuleCTest, WriteDataSuccess) {
    // テスト前にリセット
    RESET_FAKE(u4g_mem_wirte);
    
    // 戻り値を設定
    u4g_mem_wirte_fake.return_val = 4;
    
    // 関数を呼び出し
    u4 result = moduleC_write_data(test_data, 4);
    
    // 検証
    EXPECT_EQ(4, result);
    EXPECT_EQ(1, u4g_mem_wirte_fake.call_count);
}
```

#### FFF マクロリファレンス

| マクロ | 説明 |
|--------|------|
| `DEFINE_FFF_GLOBALS` | グローバルスタブ変数を定義 |
| `FAKE_VALUE_FUNC0-20` | N 個の引数を持つスタブを宣言 |
| `RESET_FAKE(func)` | スタブをリセット |
| `func_fake.return_val` | 戻り値を設定 |
| `func_fake.arg0_val` | 第 1 引数の値を取得 |
| `func_fake.arg1_val` | 第 2 引数の値を取得 |
| `func_fake.call_count` | 呼び出し回数を取得 |

## テスト結果ファイル

ビルドディレクトリ内に以下が生成されます：

- `tests/moduleC/CMakeFiles/test_moduleC.dir/test_moduleC.cpp.gcda`: カバレッジデータ
- `tests/moduleC/CMakeFiles/test_moduleC.dir/test_moduleC.cpp.gcno`: カバレッジメタデータ

### カバレッジレポート生成

```bash
# gcovr を使用したカバレッジレポート
cd build
gcovr --root .. --html-details coverage.html

# または lcov を使用
lcov --capture --directory . --output-file coverage.info
genhtml coverage.info --output-directory html
```
